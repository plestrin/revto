#include <stdlib.h>
#include <stdio.h>

#include "key_twofish.h"

#include "util.h"

#define TWOFISH_NB_ROUND_KEY		40

#define TWOFISH_ROUND_KEY_NB_BIT 	(32 * TWOFISH_NB_ROUND_KEY)
#define TWOFISH_ROUND_KEY_NB_BYTE 	(4 * TWOFISH_NB_ROUND_KEY)
#define TWOFISH_ROUND_KEY_NB_WORD 	TWOFISH_NB_ROUND_KEY

#define TWOFISH_128_NB_BIT_KEY 		128
#define TWOFISH_128_NB_BYTE_KEY		16
#define TWOFISH_128_NB_WORD_KEY 	4

#define TWOFISH_192_NB_BIT_KEY 		192
#define TWOFISH_192_NB_BYTE_KEY 	24
#define TWOFISH_192_NB_WORD_KEY 	6

#define TWOFISH_256_NB_BIT_KEY 		256
#define TWOFISH_256_NB_BYTE_KEY 	32
#define TWOFISH_256_NB_WORD_KEY 	8

struct subkeyByteEntry{
	uint32_t nb_key;
	uint32_t key_offset;
};

struct twofish192MeetTable{
	struct subkeyByteEntry 	entries[2][4][256];
	uint8_t 				keys[2][4][256];
};

struct twofish256MeetTable{
	struct subkeyByteEntry 	entries[2][4][256];
	uint8_t 				keys[2][4][256*256*2];
};

static const uint8_t IBOX[2][256] = {
	{
		0xf7, 0x31, 0xc7, 0x5a, 0x04, 0xb6, 0x84, 0xdd,
		0x7d, 0x72, 0x9e, 0x47, 0x3d, 0x10, 0xbd, 0xf6,
		0xf1, 0x8b, 0xdb, 0x1d, 0xc1, 0xd9, 0x3c, 0xcb,
		0x14, 0x28, 0xbb, 0x9b, 0x5d, 0x81, 0x5e, 0xcd,
		0x90, 0xf2, 0xda, 0x27, 0x74, 0x46, 0x1b, 0x8e,
		0xc0, 0xc3, 0xb0, 0xea, 0x45, 0xa4, 0x33, 0xb3,
		0x23, 0x8c, 0xee, 0x6c, 0xdf, 0x12, 0xfa, 0x1a,
		0x0f, 0x6a, 0x42, 0xa7, 0xc5, 0x2a, 0xad, 0xc2,
		0xeb, 0x88, 0xfb, 0x18, 0x7c, 0x53, 0xab, 0xa8,
		0x1f, 0xa2, 0xfc, 0xbc, 0xc6, 0x7b, 0x49, 0xa5,
		0xe1, 0x35, 0x9a, 0x4c, 0x25, 0xcc, 0x5b, 0xd0,
		0xdc, 0x2b, 0xbf, 0x29, 0x95, 0xf5, 0xfd, 0x9c,
		0x92, 0x3f, 0x6e, 0x30, 0xaf, 0xe4, 0x57, 0x01,
		0xe3, 0xae, 0x4d, 0x4b, 0x17, 0xaa, 0xe0, 0xf8,
		0x85, 0x6f, 0xd7, 0x44, 0xd3, 0x19, 0x07, 0x69,
		0x0b, 0x71, 0xb7, 0x89, 0x37, 0xcf, 0xd8, 0xb9,
		0x0a, 0x70, 0x2f, 0x32, 0x24, 0xa1, 0x7e, 0xa9,
		0xc4, 0x4a, 0xce, 0x22, 0x41, 0xd2, 0x62, 0xa6,
		0x8f, 0xa0, 0x09, 0x9d, 0x1e, 0x59, 0x94, 0xb5,
		0x13, 0xde, 0x08, 0x36, 0x99, 0xf9, 0x98, 0xd6,
		0x8a, 0x80, 0x2e, 0x06, 0xef, 0x3a, 0x38, 0xbe,
		0xe9, 0x00, 0x82, 0x97, 0xb8, 0x73, 0x2d, 0x6b,
		0xca, 0x96, 0x86, 0x02, 0x4e, 0x63, 0x56, 0xd4,
		0xc8, 0x7a, 0x67, 0x48, 0xe5, 0x52, 0x3b, 0x66,
		0x40, 0xfe, 0x8d, 0x61, 0xd5, 0x79, 0x11, 0xd1,
		0xe8, 0x6d, 0xf0, 0xb2, 0x58, 0x75, 0xb1, 0x65,
		0x21, 0x0e, 0x87, 0xf4, 0x5c, 0xba, 0xac, 0x5f,
		0x77, 0x34, 0xc9, 0xe6, 0xec, 0x0d, 0xe2, 0x26,
		0xff, 0x50, 0x54, 0x3e, 0x0c, 0x78, 0x51, 0x7f,
		0x03, 0x64, 0x68, 0x39, 0x16, 0x83, 0xa3, 0x9f,
		0xf3, 0x4f, 0x20, 0x2c, 0x55, 0x43, 0x91, 0x15,
		0xe7, 0x76, 0x1c, 0x60, 0xb4, 0x05, 0xed, 0x93
	},
	{
		0x25, 0xa7, 0xed, 0x68, 0xf5, 0xbe, 0x1e, 0x32,
		0x6a, 0xfd, 0xd6, 0x88, 0x71, 0xea, 0x2b, 0x19,
		0x4b, 0x5c, 0xe8, 0x50, 0x33, 0xd3, 0xf8, 0x7f,
		0xa8, 0xb7, 0x9d, 0x1b, 0x8b, 0x83, 0xf2, 0xab,
		0x62, 0x9b, 0xe0, 0xa9, 0x54, 0xf9, 0x92, 0x4e,
		0x4d, 0xd0, 0x96, 0x6e, 0x36, 0xad, 0xd1, 0xee,
		0x18, 0xa5, 0x11, 0x91, 0xdb, 0xdc, 0x3e, 0x14,
		0x40, 0xa1, 0x75, 0x56, 0xc6, 0x84, 0x8f, 0x1f,
		0x6c, 0x74, 0x49, 0xce, 0xcb, 0x0c, 0x55, 0xd9,
		0xaf, 0x97, 0x08, 0x0f, 0x3a, 0xcd, 0xac, 0xb0,
		0xf4, 0x3f, 0xeb, 0x8e, 0x3b, 0xfc, 0xfb, 0xbb,
		0xb6, 0xd4, 0x43, 0x23, 0xb5, 0x2d, 0x20, 0x93,
		0x45, 0xf1, 0x46, 0xc1, 0xbf, 0xb2, 0x80, 0xbc,
		0xca, 0xcf, 0xdd, 0x0b, 0x48, 0x28, 0xd8, 0x69,
		0x57, 0x15, 0x89, 0x39, 0x3d, 0x00, 0x95, 0x65,
		0xb4, 0x70, 0x7e, 0x05, 0x4c, 0x0d, 0x7c, 0xbd,
		0x2c, 0x98, 0x73, 0x61, 0x31, 0x5a, 0xfa, 0x1c,
		0x99, 0xe4, 0x24, 0xa6, 0x4f, 0xb8, 0xb3, 0x90,
		0x35, 0xff, 0x3c, 0x5e, 0x81, 0x51, 0x47, 0x7b,
		0xba, 0xa2, 0x79, 0xe3, 0x52, 0x27, 0xd7, 0x64,
		0x30, 0x82, 0xe9, 0x37, 0x7a, 0xc7, 0x60, 0x8a,
		0xd5, 0xef, 0x72, 0xe7, 0xd2, 0xa4, 0x22, 0xc0,
		0x41, 0x2a, 0x38, 0x87, 0xf3, 0x34, 0xc2, 0xc5,
		0x5f, 0x77, 0x21, 0xec, 0x26, 0x42, 0xfe, 0x6b,
		0xe2, 0x29, 0xf7, 0x66, 0x9c, 0xa0, 0x02, 0x53,
		0x07, 0xe1, 0x58, 0x5b, 0x67, 0xa3, 0xc8, 0xde,
		0x5d, 0x8d, 0x2e, 0x09, 0xe5, 0x2f, 0x10, 0xf0,
		0x12, 0x9f, 0x7d, 0x04, 0xdf, 0xaa, 0x86, 0xda,
		0xcc, 0x17, 0x6f, 0x59, 0x78, 0xb9, 0x0a, 0x6d,
		0x0e, 0xc9, 0x76, 0x9e, 0x94, 0xe6, 0x9a, 0x8c,
		0x85, 0x16, 0xb1, 0x01, 0x03, 0xc4, 0xf6, 0x4a,
		0x1a, 0xae, 0x1d, 0x06, 0x44, 0x13, 0xc3, 0x63
	}
};

static const uint8_t SBOX[2][256] = {
	{
		0xa9, 0x67, 0xb3, 0xe8, 0x04, 0xfd, 0xa3, 0x76,
		0x9a, 0x92, 0x80, 0x78, 0xe4, 0xdd, 0xd1, 0x38,
		0x0d, 0xc6, 0x35, 0x98, 0x18, 0xf7, 0xec, 0x6c,
		0x43, 0x75, 0x37, 0x26, 0xfa, 0x13, 0x94, 0x48,
		0xf2, 0xd0, 0x8b, 0x30, 0x84, 0x54, 0xdf, 0x23,
		0x19, 0x5b, 0x3d, 0x59, 0xf3, 0xae, 0xa2, 0x82,
		0x63, 0x01, 0x83, 0x2e, 0xd9, 0x51, 0x9b, 0x7c,
		0xa6, 0xeb, 0xa5, 0xbe, 0x16, 0x0c, 0xe3, 0x61,
		0xc0, 0x8c, 0x3a, 0xf5, 0x73, 0x2c, 0x25, 0x0b,
		0xbb, 0x4e, 0x89, 0x6b, 0x53, 0x6a, 0xb4, 0xf1,
		0xe1, 0xe6, 0xbd, 0x45, 0xe2, 0xf4, 0xb6, 0x66,
		0xcc, 0x95, 0x03, 0x56, 0xd4, 0x1c, 0x1e, 0xd7,
		0xfb, 0xc3, 0x8e, 0xb5, 0xe9, 0xcf, 0xbf, 0xba,
		0xea, 0x77, 0x39, 0xaf, 0x33, 0xc9, 0x62, 0x71,
		0x81, 0x79, 0x09, 0xad, 0x24, 0xcd, 0xf9, 0xd8,
		0xe5, 0xc5, 0xb9, 0x4d, 0x44, 0x08, 0x86, 0xe7,
		0xa1, 0x1d, 0xaa, 0xed, 0x06, 0x70, 0xb2, 0xd2,
		0x41, 0x7b, 0xa0, 0x11, 0x31, 0xc2, 0x27, 0x90,
		0x20, 0xf6, 0x60, 0xff, 0x96, 0x5c, 0xb1, 0xab,
		0x9e, 0x9c, 0x52, 0x1b, 0x5f, 0x93, 0x0a, 0xef,
		0x91, 0x85, 0x49, 0xee, 0x2d, 0x4f, 0x8f, 0x3b,
		0x47, 0x87, 0x6d, 0x46, 0xd6, 0x3e, 0x69, 0x64,
		0x2a, 0xce, 0xcb, 0x2f, 0xfc, 0x97, 0x05, 0x7a,
		0xac, 0x7f, 0xd5, 0x1a, 0x4b, 0x0e, 0xa7, 0x5a,
		0x28, 0x14, 0x3f, 0x29, 0x88, 0x3c, 0x4c, 0x02,
		0xb8, 0xda, 0xb0, 0x17, 0x55, 0x1f, 0x8a, 0x7d,
		0x57, 0xc7, 0x8d, 0x74, 0xb7, 0xc4, 0x9f, 0x72,
		0x7e, 0x15, 0x22, 0x12, 0x58, 0x07, 0x99, 0x34,
		0x6e, 0x50, 0xde, 0x68, 0x65, 0xbc, 0xdb, 0xf8,
		0xc8, 0xa8, 0x2b, 0x40, 0xdc, 0xfe, 0x32, 0xa4,
		0xca, 0x10, 0x21, 0xf0, 0xd3, 0x5d, 0x0f, 0x00,
		0x6f, 0x9d, 0x36, 0x42, 0x4a, 0x5e, 0xc1, 0xe0
	},
	{
		0x75, 0xf3, 0xc6, 0xf4, 0xdb, 0x7b, 0xfb, 0xc8,
		0x4a, 0xd3, 0xe6, 0x6b, 0x45, 0x7d, 0xe8, 0x4b,
		0xd6, 0x32, 0xd8, 0xfd, 0x37, 0x71, 0xf1, 0xe1,
		0x30, 0x0f, 0xf8, 0x1b, 0x87, 0xfa, 0x06, 0x3f,
		0x5e, 0xba, 0xae, 0x5b, 0x8a, 0x00, 0xbc, 0x9d,
		0x6d, 0xc1, 0xb1, 0x0e, 0x80, 0x5d, 0xd2, 0xd5,
		0xa0, 0x84, 0x07, 0x14, 0xb5, 0x90, 0x2c, 0xa3,
		0xb2, 0x73, 0x4c, 0x54, 0x92, 0x74, 0x36, 0x51,
		0x38, 0xb0, 0xbd, 0x5a, 0xfc, 0x60, 0x62, 0x96,
		0x6c, 0x42, 0xf7, 0x10, 0x7c, 0x28, 0x27, 0x8c,
		0x13, 0x95, 0x9c, 0xc7, 0x24, 0x46, 0x3b, 0x70,
		0xca, 0xe3, 0x85, 0xcb, 0x11, 0xd0, 0x93, 0xb8,
		0xa6, 0x83, 0x20, 0xff, 0x9f, 0x77, 0xc3, 0xcc,
		0x03, 0x6f, 0x08, 0xbf, 0x40, 0xe7, 0x2b, 0xe2,
		0x79, 0x0c, 0xaa, 0x82, 0x41, 0x3a, 0xea, 0xb9,
		0xe4, 0x9a, 0xa4, 0x97, 0x7e, 0xda, 0x7a, 0x17,
		0x66, 0x94, 0xa1, 0x1d, 0x3d, 0xf0, 0xde, 0xb3,
		0x0b, 0x72, 0xa7, 0x1c, 0xef, 0xd1, 0x53, 0x3e,
		0x8f, 0x33, 0x26, 0x5f, 0xec, 0x76, 0x2a, 0x49,
		0x81, 0x88, 0xee, 0x21, 0xc4, 0x1a, 0xeb, 0xd9,
		0xc5, 0x39, 0x99, 0xcd, 0xad, 0x31, 0x8b, 0x01,
		0x18, 0x23, 0xdd, 0x1f, 0x4e, 0x2d, 0xf9, 0x48,
		0x4f, 0xf2, 0x65, 0x8e, 0x78, 0x5c, 0x58, 0x19,
		0x8d, 0xe5, 0x98, 0x57, 0x67, 0x7f, 0x05, 0x64,
		0xaf, 0x63, 0xb6, 0xfe, 0xf5, 0xb7, 0x3c, 0xa5,
		0xce, 0xe9, 0x68, 0x44, 0xe0, 0x4d, 0x43, 0x69,
		0x29, 0x2e, 0xac, 0x15, 0x59, 0xa8, 0x0a, 0x9e,
		0x6e, 0x47, 0xdf, 0x34, 0x35, 0x6a, 0xcf, 0xdc,
		0x22, 0xc9, 0xc0, 0x9b, 0x89, 0xd4, 0xed, 0xab,
		0x12, 0xa2, 0x0d, 0x52, 0xbb, 0x02, 0x2f, 0xa9,
		0xd7, 0x61, 0x1e, 0xb4, 0x50, 0x04, 0xf6, 0xc2,
		0x16, 0x25, 0x86, 0x56, 0x55, 0x09, 0xbe, 0x91
	}
};

static const uint32_t inv_MDS[4][256] = {
	{
		0x00000000, 0x32f21bbb, 0x648d361f, 0x567f2da4, 0xc8736c3e, 0xfa817785, 0xacfe5a21, 0x9e0c419a,
		0xf9e6d87c, 0xcb14c3c7, 0x9d6bee63, 0xaf99f5d8, 0x3195b442, 0x0367aff9, 0x5518825d, 0x67ea99e6,
		0x9ba5d9f8, 0xa957c243, 0xff28efe7, 0xcddaf45c, 0x53d6b5c6, 0x6124ae7d, 0x375b83d9, 0x05a99862,
		0x62430184, 0x50b11a3f, 0x06ce379b, 0x343c2c20, 0xaa306dba, 0x98c27601, 0xcebd5ba5, 0xfc4f401e,
		0x5f23db99, 0x6dd1c022, 0x3baeed86, 0x095cf63d, 0x9750b7a7, 0xa5a2ac1c, 0xf3dd81b8, 0xc12f9a03,
		0xa6c503e5, 0x9437185e, 0xc24835fa, 0xf0ba2e41, 0x6eb66fdb, 0x5c447460, 0x0a3b59c4, 0x38c9427f,
		0xc4860261, 0xf67419da, 0xa00b347e, 0x92f92fc5, 0x0cf56e5f, 0x3e0775e4, 0x68785840, 0x5a8a43fb,
		0x3d60da1d, 0x0f92c1a6, 0x59edec02, 0x6b1ff7b9, 0xf513b623, 0xc7e1ad98, 0x919e803c, 0xa36c9b87,
		0xbe46df5b, 0x8cb4c4e0, 0xdacbe944, 0xe839f2ff, 0x7635b365, 0x44c7a8de, 0x12b8857a, 0x204a9ec1,
		0x47a00727, 0x75521c9c, 0x232d3138, 0x11df2a83, 0x8fd36b19, 0xbd2170a2, 0xeb5e5d06, 0xd9ac46bd,
		0x25e306a3, 0x17111d18, 0x416e30bc, 0x739c2b07, 0xed906a9d, 0xdf627126, 0x891d5c82, 0xbbef4739,
		0xdc05dedf, 0xeef7c564, 0xb888e8c0, 0x8a7af37b, 0x1476b2e1, 0x2684a95a, 0x70fb84fe, 0x42099f45,
		0xe16504c2, 0xd3971f79, 0x85e832dd, 0xb71a2966, 0x291668fc, 0x1be47347, 0x4d9b5ee3, 0x7f694558,
		0x1883dcbe, 0x2a71c705, 0x7c0eeaa1, 0x4efcf11a, 0xd0f0b080, 0xe202ab3b, 0xb47d869f, 0x868f9d24,
		0x7ac0dd3a, 0x4832c681, 0x1e4deb25, 0x2cbff09e, 0xb2b3b104, 0x8041aabf, 0xd63e871b, 0xe4cc9ca0,
		0x83260546, 0xb1d41efd, 0xe7ab3359, 0xd55928e2, 0x4b556978, 0x79a772c3, 0x2fd85f67, 0x1d2a44dc,
		0x158cd7b6, 0x277ecc0d, 0x7101e1a9, 0x43f3fa12, 0xddffbb88, 0xef0da033, 0xb9728d97, 0x8b80962c,
		0xec6a0fca, 0xde981471, 0x88e739d5, 0xba15226e, 0x241963f4, 0x16eb784f, 0x409455eb, 0x72664e50,
		0x8e290e4e, 0xbcdb15f5, 0xeaa43851, 0xd85623ea, 0x465a6270, 0x74a879cb, 0x22d7546f, 0x10254fd4,
		0x77cfd632, 0x453dcd89, 0x1342e02d, 0x21b0fb96, 0xbfbcba0c, 0x8d4ea1b7, 0xdb318c13, 0xe9c397a8,
		0x4aaf0c2f, 0x785d1794, 0x2e223a30, 0x1cd0218b, 0x82dc6011, 0xb02e7baa, 0xe651560e, 0xd4a34db5,
		0xb349d453, 0x81bbcfe8, 0xd7c4e24c, 0xe536f9f7, 0x7b3ab86d, 0x49c8a3d6, 0x1fb78e72, 0x2d4595c9,
		0xd10ad5d7, 0xe3f8ce6c, 0xb587e3c8, 0x8775f873, 0x1979b9e9, 0x2b8ba252, 0x7df48ff6, 0x4f06944d,
		0x28ec0dab, 0x1a1e1610, 0x4c613bb4, 0x7e93200f, 0xe09f6195, 0xd26d7a2e, 0x8412578a, 0xb6e04c31,
		0xabca08ed, 0x99381356, 0xcf473ef2, 0xfdb52549, 0x63b964d3, 0x514b7f68, 0x073452cc, 0x35c64977,
		0x522cd091, 0x60decb2a, 0x36a1e68e, 0x0453fd35, 0x9a5fbcaf, 0xa8ada714, 0xfed28ab0, 0xcc20910b,
		0x306fd115, 0x029dcaae, 0x54e2e70a, 0x6610fcb1, 0xf81cbd2b, 0xcaeea690, 0x9c918b34, 0xae63908f,
		0xc9890969, 0xfb7b12d2, 0xad043f76, 0x9ff624cd, 0x01fa6557, 0x33087eec, 0x65775348, 0x578548f3,
		0xf4e9d374, 0xc61bc8cf, 0x9064e56b, 0xa296fed0, 0x3c9abf4a, 0x0e68a4f1, 0x58178955, 0x6ae592ee,
		0x0d0f0b08, 0x3ffd10b3, 0x69823d17, 0x5b7026ac, 0xc57c6736, 0xf78e7c8d, 0xa1f15129, 0x93034a92,
		0x6f4c0a8c, 0x5dbe1137, 0x0bc13c93, 0x39332728, 0xa73f66b2, 0x95cd7d09, 0xc3b250ad, 0xf1404b16,
		0x96aad2f0, 0xa458c94b, 0xf227e4ef, 0xc0d5ff54, 0x5ed9bece, 0x6c2ba575, 0x3a5488d1, 0x08a6936a
	},
	{
		0x00000000, 0xbb89edc4, 0x1f7bb3e1, 0xa4f25e25, 0x3ef60fab, 0x857fe26f, 0x218dbc4a, 0x9a04518e,
		0x7c851e3f, 0xc70cf3fb, 0x63feadde, 0xd877401a, 0x42731194, 0xf9fafc50, 0x5d08a275, 0xe6814fb1,
		0xf8633c7e, 0x43ead1ba, 0xe7188f9f, 0x5c91625b, 0xc69533d5, 0x7d1cde11, 0xd9ee8034, 0x62676df0,
		0x84e62241, 0x3f6fcf85, 0x9b9d91a0, 0x20147c64, 0xba102dea, 0x0199c02e, 0xa56b9e0b, 0x1ee273cf,
		0x99c678fc, 0x224f9538, 0x86bdcb1d, 0x3d3426d9, 0xa7307757, 0x1cb99a93, 0xb84bc4b6, 0x03c22972,
		0xe54366c3, 0x5eca8b07, 0xfa38d522, 0x41b138e6, 0xdbb56968, 0x603c84ac, 0xc4ceda89, 0x7f47374d,
		0x61a54482, 0xda2ca946, 0x7edef763, 0xc5571aa7, 0x5f534b29, 0xe4daa6ed, 0x4028f8c8, 0xfba1150c,
		0x1d205abd, 0xa6a9b779, 0x025be95c, 0xb9d20498, 0x23d65516, 0x985fb8d2, 0x3cade6f7, 0x87240b33,
		0x5be5f091, 0xe06c1d55, 0x449e4370, 0xff17aeb4, 0x6513ff3a, 0xde9a12fe, 0x7a684cdb, 0xc1e1a11f,
		0x2760eeae, 0x9ce9036a, 0x381b5d4f, 0x8392b08b, 0x1996e105, 0xa21f0cc1, 0x06ed52e4, 0xbd64bf20,
		0xa386ccef, 0x180f212b, 0xbcfd7f0e, 0x077492ca, 0x9d70c344, 0x26f92e80, 0x820b70a5, 0x39829d61,
		0xdf03d2d0, 0x648a3f14, 0xc0786131, 0x7bf18cf5, 0xe1f5dd7b, 0x5a7c30bf, 0xfe8e6e9a, 0x4507835e,
		0xc223886d, 0x79aa65a9, 0xdd583b8c, 0x66d1d648, 0xfcd587c6, 0x475c6a02, 0xe3ae3427, 0x5827d9e3,
		0xbea69652, 0x052f7b96, 0xa1dd25b3, 0x1a54c877, 0x805099f9, 0x3bd9743d, 0x9f2b2a18, 0x24a2c7dc,
		0x3a40b413, 0x81c959d7, 0x253b07f2, 0x9eb2ea36, 0x04b6bbb8, 0xbf3f567c, 0x1bcd0859, 0xa044e59d,
		0x46c5aa2c, 0xfd4c47e8, 0x59be19cd, 0xe237f409, 0x7833a587, 0xc3ba4843, 0x67481666, 0xdcc1fba2,
		0xb6a3894b, 0x0d2a648f, 0xa9d83aaa, 0x1251d76e, 0x885586e0, 0x33dc6b24, 0x972e3501, 0x2ca7d8c5,
		0xca269774, 0x71af7ab0, 0xd55d2495, 0x6ed4c951, 0xf4d098df, 0x4f59751b, 0xebab2b3e, 0x5022c6fa,
		0x4ec0b535, 0xf54958f1, 0x51bb06d4, 0xea32eb10, 0x7036ba9e, 0xcbbf575a, 0x6f4d097f, 0xd4c4e4bb,
		0x3245ab0a, 0x89cc46ce, 0x2d3e18eb, 0x96b7f52f, 0x0cb3a4a1, 0xb73a4965, 0x13c81740, 0xa841fa84,
		0x2f65f1b7, 0x94ec1c73, 0x301e4256, 0x8b97af92, 0x1193fe1c, 0xaa1a13d8, 0x0ee84dfd, 0xb561a039,
		0x53e0ef88, 0xe869024c, 0x4c9b5c69, 0xf712b1ad, 0x6d16e023, 0xd69f0de7, 0x726d53c2, 0xc9e4be06,
		0xd706cdc9, 0x6c8f200d, 0xc87d7e28, 0x73f493ec, 0xe9f0c262, 0x52792fa6, 0xf68b7183, 0x4d029c47,
		0xab83d3f6, 0x100a3e32, 0xb4f86017, 0x0f718dd3, 0x9575dc5d, 0x2efc3199, 0x8a0e6fbc, 0x31878278,
		0xed4679da, 0x56cf941e, 0xf23dca3b, 0x49b427ff, 0xd3b07671, 0x68399bb5, 0xcccbc590, 0x77422854,
		0x91c367e5, 0x2a4a8a21, 0x8eb8d404, 0x353139c0, 0xaf35684e, 0x14bc858a, 0xb04edbaf, 0x0bc7366b,
		0x152545a4, 0xaeaca860, 0x0a5ef645, 0xb1d71b81, 0x2bd34a0f, 0x905aa7cb, 0x34a8f9ee, 0x8f21142a,
		0x69a05b9b, 0xd229b65f, 0x76dbe87a, 0xcd5205be, 0x57565430, 0xecdfb9f4, 0x482de7d1, 0xf3a40a15,
		0x74800126, 0xcf09ece2, 0x6bfbb2c7, 0xd0725f03, 0x4a760e8d, 0xf1ffe349, 0x550dbd6c, 0xee8450a8,
		0x08051f19, 0xb38cf2dd, 0x177eacf8, 0xacf7413c, 0x36f310b2, 0x8d7afd76, 0x2988a353, 0x92014e97,
		0x8ce33d58, 0x376ad09c, 0x93988eb9, 0x2811637d, 0xb21532f3, 0x099cdf37, 0xad6e8112, 0x16e76cd6,
		0xf0662367, 0x4befcea3, 0xef1d9086, 0x54947d42, 0xce902ccc, 0x7519c108, 0xd1eb9f2d, 0x6a6272e9
	},
	{
		0x00000000, 0x1b7bbfed, 0x36f617b3, 0x2d8da85e, 0x6c852e0f, 0x77fe91e2, 0x5a7339bc, 0x41088651,
		0xd8635c1e, 0xc318e3f3, 0xee954bad, 0xf5eef440, 0xb4e67211, 0xaf9dcdfc, 0x821065a2, 0x996bda4f,
		0xd9c6b83c, 0xc2bd07d1, 0xef30af8f, 0xf44b1062, 0xb5439633, 0xae3829de, 0x83b58180, 0x98ce3e6d,
		0x01a5e422, 0x1ade5bcf, 0x3753f391, 0x2c284c7c, 0x6d20ca2d, 0x765b75c0, 0x5bd6dd9e, 0x40ad6273,
		0xdbe51978, 0xc09ea695, 0xed130ecb, 0xf668b126, 0xb7603777, 0xac1b889a, 0x819620c4, 0x9aed9f29,
		0x03864566, 0x18fdfa8b, 0x357052d5, 0x2e0bed38, 0x6f036b69, 0x7478d484, 0x59f57cda, 0x428ec337,
		0x0223a144, 0x19581ea9, 0x34d5b6f7, 0x2fae091a, 0x6ea68f4b, 0x75dd30a6, 0x585098f8, 0x432b2715,
		0xda40fd5a, 0xc13b42b7, 0xecb6eae9, 0xf7cd5504, 0xb6c5d355, 0xadbe6cb8, 0x8033c4e6, 0x9b487b0b,
		0xdfa332f0, 0xc4d88d1d, 0xe9552543, 0xf22e9aae, 0xb3261cff, 0xa85da312, 0x85d00b4c, 0x9eabb4a1,
		0x07c06eee, 0x1cbbd103, 0x3136795d, 0x2a4dc6b0, 0x6b4540e1, 0x703eff0c, 0x5db35752, 0x46c8e8bf,
		0x06658acc, 0x1d1e3521, 0x30939d7f, 0x2be82292, 0x6ae0a4c3, 0x719b1b2e, 0x5c16b370, 0x476d0c9d,
		0xde06d6d2, 0xc57d693f, 0xe8f0c161, 0xf38b7e8c, 0xb283f8dd, 0xa9f84730, 0x8475ef6e, 0x9f0e5083,
		0x04462b88, 0x1f3d9465, 0x32b03c3b, 0x29cb83d6, 0x68c30587, 0x73b8ba6a, 0x5e351234, 0x454eadd9,
		0xdc257796, 0xc75ec87b, 0xead36025, 0xf1a8dfc8, 0xb0a05999, 0xabdbe674, 0x86564e2a, 0x9d2df1c7,
		0xdd8093b4, 0xc6fb2c59, 0xeb768407, 0xf00d3bea, 0xb105bdbb, 0xaa7e0256, 0x87f3aa08, 0x9c8815e5,
		0x05e3cfaa, 0x1e987047, 0x3315d819, 0x286e67f4, 0x6966e1a5, 0x721d5e48, 0x5f90f616, 0x44eb49fb,
		0xd72f6489, 0xcc54db64, 0xe1d9733a, 0xfaa2ccd7, 0xbbaa4a86, 0xa0d1f56b, 0x8d5c5d35, 0x9627e2d8,
		0x0f4c3897, 0x1437877a, 0x39ba2f24, 0x22c190c9, 0x63c91698, 0x78b2a975, 0x553f012b, 0x4e44bec6,
		0x0ee9dcb5, 0x15926358, 0x381fcb06, 0x236474eb, 0x626cf2ba, 0x79174d57, 0x549ae509, 0x4fe15ae4,
		0xd68a80ab, 0xcdf13f46, 0xe07c9718, 0xfb0728f5, 0xba0faea4, 0xa1741149, 0x8cf9b917, 0x978206fa,
		0x0cca7df1, 0x17b1c21c, 0x3a3c6a42, 0x2147d5af, 0x604f53fe, 0x7b34ec13, 0x56b9444d, 0x4dc2fba0,
		0xd4a921ef, 0xcfd29e02, 0xe25f365c, 0xf92489b1, 0xb82c0fe0, 0xa357b00d, 0x8eda1853, 0x95a1a7be,
		0xd50cc5cd, 0xce777a20, 0xe3fad27e, 0xf8816d93, 0xb989ebc2, 0xa2f2542f, 0x8f7ffc71, 0x9404439c,
		0x0d6f99d3, 0x1614263e, 0x3b998e60, 0x20e2318d, 0x61eab7dc, 0x7a910831, 0x571ca06f, 0x4c671f82,
		0x088c5679, 0x13f7e994, 0x3e7a41ca, 0x2501fe27, 0x64097876, 0x7f72c79b, 0x52ff6fc5, 0x4984d028,
		0xd0ef0a67, 0xcb94b58a, 0xe6191dd4, 0xfd62a239, 0xbc6a2468, 0xa7119b85, 0x8a9c33db, 0x91e78c36,
		0xd14aee45, 0xca3151a8, 0xe7bcf9f6, 0xfcc7461b, 0xbdcfc04a, 0xa6b47fa7, 0x8b39d7f9, 0x90426814,
		0x0929b25b, 0x12520db6, 0x3fdfa5e8, 0x24a41a05, 0x65ac9c54, 0x7ed723b9, 0x535a8be7, 0x4821340a,
		0xd3694f01, 0xc812f0ec, 0xe59f58b2, 0xfee4e75f, 0xbfec610e, 0xa497dee3, 0x891a76bd, 0x9261c950,
		0x0b0a131f, 0x1071acf2, 0x3dfc04ac, 0x2687bb41, 0x678f3d10, 0x7cf482fd, 0x51792aa3, 0x4a02954e,
		0x0aaff73d, 0x11d448d0, 0x3c59e08e, 0x27225f63, 0x662ad932, 0x7d5166df, 0x50dcce81, 0x4ba7716c,
		0xd2ccab23, 0xc9b714ce, 0xe43abc90, 0xff41037d, 0xbe49852c, 0xa5323ac1, 0x88bf929f, 0x93c42d72
	},
	{
		0x00000000, 0xf2897b89, 0x8d7bf67b, 0x7ff28df2, 0x73f685f6, 0x817ffe7f, 0xfe8d738d, 0x0c040804,
		0xe6856385, 0x140c180c, 0x6bfe95fe, 0x9977ee77, 0x9573e673, 0x67fa9dfa, 0x18081008, 0xea816b81,
		0xa563c663, 0x57eabdea, 0x28183018, 0xda914b91, 0xd6954395, 0x241c381c, 0x5beeb5ee, 0xa967ce67,
		0x43e6a5e6, 0xb16fde6f, 0xce9d539d, 0x3c142814, 0x30102010, 0xc2995b99, 0xbd6bd66b, 0x4fe2ade2,
		0x23c6e5c6, 0xd14f9e4f, 0xaebd13bd, 0x5c346834, 0x50306030, 0xa2b91bb9, 0xdd4b964b, 0x2fc2edc2,
		0xc5438643, 0x37cafdca, 0x48387038, 0xbab10bb1, 0xb6b503b5, 0x443c783c, 0x3bcef5ce, 0xc9478e47,
		0x86a523a5, 0x742c582c, 0x0bded5de, 0xf957ae57, 0xf553a653, 0x07daddda, 0x78285028, 0x8aa12ba1,
		0x60204020, 0x92a93ba9, 0xed5bb65b, 0x1fd2cdd2, 0x13d6c5d6, 0xe15fbe5f, 0x9ead33ad, 0x6c244824,
		0x46e5a3e5, 0xb46cd86c, 0xcb9e559e, 0x39172e17, 0x35132613, 0xc79a5d9a, 0xb868d068, 0x4ae1abe1,
		0xa060c060, 0x52e9bbe9, 0x2d1b361b, 0xdf924d92, 0xd3964596, 0x211f3e1f, 0x5eedb3ed, 0xac64c864,
		0xe3866586, 0x110f1e0f, 0x6efd93fd, 0x9c74e874, 0x9070e070, 0x62f99bf9, 0x1d0b160b, 0xef826d82,
		0x05030603, 0xf78a7d8a, 0x8878f078, 0x7af18bf1, 0x76f583f5, 0x847cf87c, 0xfb8e758e, 0x09070e07,
		0x65234623, 0x97aa3daa, 0xe858b058, 0x1ad1cbd1, 0x16d5c3d5, 0xe45cb85c, 0x9bae35ae, 0x69274e27,
		0x83a625a6, 0x712f5e2f, 0x0eddd3dd, 0xfc54a854, 0xf050a050, 0x02d9dbd9, 0x7d2b562b, 0x8fa22da2,
		0xc0408040, 0x32c9fbc9, 0x4d3b763b, 0xbfb20db2, 0xb3b605b6, 0x413f7e3f, 0x3ecdf3cd, 0xcc448844,
		0x26c5e3c5, 0xd44c984c, 0xabbe15be, 0x59376e37, 0x55336633, 0xa7ba1dba, 0xd8489048, 0x2ac1ebc1,
		0x8ca32fa3, 0x7e2a542a, 0x01d8d9d8, 0xf351a251, 0xff55aa55, 0x0ddcd1dc, 0x722e5c2e, 0x80a727a7,
		0x6a264c26, 0x98af37af, 0xe75dba5d, 0x15d4c1d4, 0x19d0c9d0, 0xeb59b259, 0x94ab3fab, 0x66224422,
		0x29c0e9c0, 0xdb499249, 0xa4bb1fbb, 0x56326432, 0x5a366c36, 0xa8bf17bf, 0xd74d9a4d, 0x25c4e1c4,
		0xcf458a45, 0x3dccf1cc, 0x423e7c3e, 0xb0b707b7, 0xbcb30fb3, 0x4e3a743a, 0x31c8f9c8, 0xc3418241,
		0xaf65ca65, 0x5decb1ec, 0x221e3c1e, 0xd0974797, 0xdc934f93, 0x2e1a341a, 0x51e8b9e8, 0xa361c261,
		0x49e0a9e0, 0xbb69d269, 0xc49b5f9b, 0x36122412, 0x3a162c16, 0xc89f579f, 0xb76dda6d, 0x45e4a1e4,
		0x0a060c06, 0xf88f778f, 0x877dfa7d, 0x75f481f4, 0x79f089f0, 0x8b79f279, 0xf48b7f8b, 0x06020402,
		0xec836f83, 0x1e0a140a, 0x61f899f8, 0x9371e271, 0x9f75ea75, 0x6dfc91fc, 0x120e1c0e, 0xe0876787,
		0xca468c46, 0x38cff7cf, 0x473d7a3d, 0xb5b401b4, 0xb9b009b0, 0x4b397239, 0x34cbffcb, 0xc6428442,
		0x2cc3efc3, 0xde4a944a, 0xa1b819b8, 0x53316231, 0x5f356a35, 0xadbc11bc, 0xd24e9c4e, 0x20c7e7c7,
		0x6f254a25, 0x9dac31ac, 0xe25ebc5e, 0x10d7c7d7, 0x1cd3cfd3, 0xee5ab45a, 0x91a839a8, 0x63214221,
		0x89a029a0, 0x7b295229, 0x04dbdfdb, 0xf652a452, 0xfa56ac56, 0x08dfd7df, 0x772d5a2d, 0x85a421a4,
		0xe9806980, 0x1b091209, 0x64fb9ffb, 0x9672e472, 0x9a76ec76, 0x68ff97ff, 0x170d1a0d, 0xe5846184,
		0x0f050a05, 0xfd8c718c, 0x827efc7e, 0x70f787f7, 0x7cf38ff3, 0x8e7af47a, 0xf1887988, 0x03010201,
		0x4ce3afe3, 0xbe6ad46a, 0xc1985998, 0x33112211, 0x3f152a15, 0xcd9c519c, 0xb26edc6e, 0x40e7a7e7,
		0xaa66cc66, 0x58efb7ef, 0x271d3a1d, 0xd5944194, 0xd9904990, 0x2b193219, 0x54ebbfeb, 0xa662c462
	}
};

static const uint32_t box_index[4][4] = {
	{1, 0, 0, 1},
	{1, 1, 0, 0},
	{0, 1, 0, 1},
	{0, 0, 1, 1}
};

static struct twofish192MeetTable* twofish192_meet_table;
static struct twofish256MeetTable* twofish256_meet_table;

#define ror(x, y) (((x) >> ((y) & 0x0000001f)) | ((x) << (0x00000020 - ((y) & 0x0000001f))))

#define inv_MDS_mult(x) (inv_MDS[0][((x) >> 0) & 0x000000ff] ^ inv_MDS[1][((x) >> 8) & 0x000000ff] ^ inv_MDS[2][((x) >> 16) & 0x000000ff] ^ inv_MDS[3][((x) >> 24) & 0x000000ff])

static int32_t attack128(uint8_t* buffer, uint8_t* key, uint32_t offset){
	uint32_t 	i;
	uint32_t 	j;
	uint8_t 	x;
	uint8_t 	p1;
	uint8_t 	p2;
	uint8_t 	c1;
	uint8_t 	c2;
	uint8_t 	l0;
	uint8_t 	l1;

	for (i = 0; i < 4; i++){
		c1 = buffer[4*(offset + 0) + i];
		c2 = buffer[4*(offset + 2) + i];

		x = c1 ^ c2;

		p1 = SBOX[box_index[2][i]][0 + offset];
		p2 = SBOX[box_index[2][i]][2 + offset];

		for (j = 0; j <= 0x000000ff; j++){
			if ((SBOX[box_index[3][i]][p1 ^ (uint8_t)j] ^ SBOX[box_index[3][i]][p2 ^ (uint8_t)j]) == x){
				goto C0;
			}
			R0:;
		}

		return -1;

		C0:
		l1 = j;
		l0 = SBOX[box_index[3][i]][p1 ^ l1] ^ c1;

		for (j = 1; j < TWOFISH_NB_ROUND_KEY / 2; j++){
			if ((SBOX[box_index[3][i]][SBOX[box_index[2][i]][2*j + offset] ^ l1] ^ l0) != buffer[4*(offset + 2*j) + i]){
				j = l1;
				goto R0;
			}
		}

		key[4*(offset + 0) + i] = l0;
		key[4*(offset + 2) + i] = l1;
	}

	return 0;
}

int32_t init_twofish192(){
	uint32_t 	i;
	uint32_t 	j;
	uint32_t 	k;
	uint32_t 	l;
	uint8_t 	p1;
	uint8_t 	p2;
	uint32_t 	counter;

	twofish192_meet_table = (struct twofish192MeetTable*)malloc(sizeof(struct twofish192MeetTable));
	if (twofish192_meet_table == NULL){
		log_err("unable to allocate memory");
		return -1;
	}

	for (i = 0; i < 2; i++){
		for (j = 0; j < 4; j++){
			p1 = SBOX[box_index[1][j]][0 + i];
			p2 = SBOX[box_index[1][j]][2 + i];

			for (k = 0, counter = 0; k < 256; k++){
				twofish192_meet_table->entries[i][j][k].key_offset = counter;

				for (l = 0; l < 256; l++){
					if ((SBOX[box_index[2][j]][(uint8_t)l ^ p1] ^ SBOX[box_index[2][j]][(uint8_t)l ^ p2]) == (uint8_t)k){
						twofish192_meet_table->keys[i][j][counter ++] = (uint8_t)l;
					}
				}

				twofish192_meet_table->entries[i][j][k].nb_key = counter - twofish192_meet_table->entries[i][j][k].key_offset;
			}
		}
	}

	return 0;
}

void clean_twofish192(){
	free(twofish192_meet_table);
}

static int32_t attack192(uint8_t* buffer, uint8_t* key, uint32_t offset){
	uint32_t 	i;
	uint32_t 	j;
	uint32_t 	k;
	uint8_t 	xa;
	uint8_t 	xb;
	uint8_t 	c1;
	uint8_t 	c2;
	uint8_t 	c3;
	uint8_t 	l0;
	uint8_t 	l1;
	uint8_t 	l2;

	for (i = 0; i < 4; i++){
		for (j = 0; j <= 0x000000ff; j++){
			c1 = IBOX[box_index[3][i]][buffer[4*(offset + 0) + i] ^ (uint8_t)j];
			c2 = IBOX[box_index[3][i]][buffer[4*(offset + 2) + i] ^ (uint8_t)j];
			c3 = IBOX[box_index[3][i]][buffer[4*(offset + 4) + i] ^ (uint8_t)j];

			xa = c1 ^ c2;
			xb = c1 ^ c3;

			for (k = 0; k < twofish192_meet_table->entries[offset][i][xa].nb_key; k++){
				l2 = twofish192_meet_table->keys[offset][i][twofish192_meet_table->entries[offset][i][xa].key_offset + k];
				if ((SBOX[box_index[2][i]][l2 ^ SBOX[box_index[1][i]][0 + offset]] ^ SBOX[box_index[2][i]][l2 ^ SBOX[box_index[1][i]][4 + offset]]) == xb){
					goto C0;
				}
				R0:;
			}
		}

		return -1;

		C0:
		l0 = j;
		l1 = SBOX[box_index[2][i]][SBOX[box_index[1][i]][0 + offset] ^ l2] ^ c1;

		for (j = 1; j < TWOFISH_NB_ROUND_KEY / 2; j++){
			if ((SBOX[box_index[3][i]][SBOX[box_index[2][i]][SBOX[box_index[1][i]][2*j + offset] ^ l2] ^ l1] ^ l0) != buffer[4*(offset + 2*j) + i]){
				j = l0;
				goto R0;
			}
		}

		key[4*(offset + 0) + i] = l0;
		key[4*(offset + 2) + i] = l1;
		key[4*(offset + 4) + i] = l2;
	}

	return 0;
}

int32_t init_twofish256(){
	uint32_t 	i;
	uint32_t 	j;
	uint32_t 	k;
	uint32_t 	l;
	uint32_t 	m;
	uint8_t 	p1;
	uint8_t 	p2;
	uint32_t 	counter;

	twofish256_meet_table = (struct twofish256MeetTable*)malloc(sizeof(struct twofish256MeetTable));
	if (twofish256_meet_table == NULL){
		log_err("unable to allocate memory");
		return -1;
	}

	for (i = 0; i < 2; i++){
		for (j = 0; j < 4; j++){
			p1 = SBOX[box_index[0][j]][0 + i];
			p2 = SBOX[box_index[0][j]][2 + i];

			for (k = 0, counter = 0; k < 256; k++){
				twofish256_meet_table->entries[i][j][k].key_offset = counter;

				for (l = 0; l < 256; l++){
					uint8_t tmp1;
					uint8_t tmp2;

					tmp1 = SBOX[box_index[1][j]][(uint8_t)l ^ p1];
					tmp2 = SBOX[box_index[1][j]][(uint8_t)l ^ p2];

					for (m = 0; m < 256; m++){
						if ((SBOX[box_index[2][j]][(uint8_t)m ^ tmp1] ^ SBOX[box_index[2][j]][(uint8_t)m ^ tmp2]) == (uint8_t)k){
							twofish256_meet_table->keys[i][j][counter ++] = (uint8_t)l;
							twofish256_meet_table->keys[i][j][counter ++] = (uint8_t)m;
						}
					}
				}

				twofish256_meet_table->entries[i][j][k].nb_key = (counter - twofish256_meet_table->entries[i][j][k].key_offset) / 2;
			}
		}
	}

	return 0;
}

void clean_twofish256(){
	free(twofish256_meet_table);
}

static int32_t attack256(uint8_t* buffer, uint8_t* key, uint32_t offset){
	uint32_t 	i;
	uint32_t 	j;
	uint32_t 	k;
	uint8_t 	xa;
	uint8_t 	xb;
	uint8_t 	c1;
	uint8_t 	c2;
	uint8_t 	c3;
	uint8_t 	l0;
	uint8_t 	l1;
	uint8_t 	l2;
	uint8_t 	l3;
	uint8_t 	v1;
	uint8_t 	v2;
	uint8_t 	v1_0;
	uint8_t 	v2_0;

	for (i = 0; i < 4; i++){
		v1_0 = SBOX[box_index[0][i]][0 + offset];
		v2_0 = SBOX[box_index[0][i]][4 + offset];

		for (j = 0; j <= 0x000000ff; j++){
			c1 = IBOX[box_index[3][i]][buffer[4*(offset + 0) + i] ^ (uint8_t)j];
			c2 = IBOX[box_index[3][i]][buffer[4*(offset + 2) + i] ^ (uint8_t)j];
			c3 = IBOX[box_index[3][i]][buffer[4*(offset + 4) + i] ^ (uint8_t)j];

			xa = c1 ^ c2;
			xb = c1 ^ c3;

			for (k = 0; k < twofish256_meet_table->entries[offset][i][xa].nb_key; k++){
				l3 = twofish256_meet_table->keys[offset][i][twofish256_meet_table->entries[offset][i][xa].key_offset + 2*k + 0];
				l2 = twofish256_meet_table->keys[offset][i][twofish256_meet_table->entries[offset][i][xa].key_offset + 2*k + 1];

				v1 = SBOX[box_index[2][i]][SBOX[box_index[1][i]][v1_0 ^ l3] ^ l2];
				v2 = SBOX[box_index[2][i]][SBOX[box_index[1][i]][v2_0 ^ l3] ^ l2];

				if ((v1 ^ v2) == xb){
					goto C0;
				}
				R0:;
			}
		}

		return -1;

		C0:
		l0 = j;
		l1 = v1 ^ c1;

		for (j = 1; j < TWOFISH_NB_ROUND_KEY / 2; j++){
			v1 = l3 ^ SBOX[box_index[0][i]][2*j + offset];
			v1 = l2 ^ SBOX[box_index[1][i]][v1];
			v1 = l1 ^ SBOX[box_index[2][i]][v1];
			v1 = l0 ^ SBOX[box_index[3][i]][v1];

			if (v1 != buffer[4*(offset + 2*j) + i]){
				j = l0;
				goto R0;
			}
		}

		key[4*(offset + 0) + i] = l0;
		key[4*(offset + 2) + i] = l1;
		key[4*(offset + 4) + i] = l2;
		key[4*(offset + 6) + i] = l3;
	}

	return 0;
}

void search_twofish_key(struct fileChunk* chunk, struct multiColumnPrinter* printer){
	uint64_t 	i;
	uint32_t* 	round_key;
	uint32_t 	j;
	uint8_t 	tmp[TWOFISH_ROUND_KEY_NB_BYTE];
	uint8_t 	key[TWOFISH_256_NB_BYTE_KEY];
	char 		key_str[2*TWOFISH_256_NB_BYTE_KEY + 1];

	if (chunk->length < TWOFISH_ROUND_KEY_NB_BYTE){
		return;
	}

	for (i = 0; i < chunk->length - TWOFISH_ROUND_KEY_NB_BYTE + 1; i += STEP_NB_BYTE){
		round_key = (uint32_t*)(chunk->buffer + i);

		for (j = 0; j < TWOFISH_NB_ROUND_KEY / 2; j++){
			uint32_t a;
			uint32_t b;

			b = ror(round_key[2*j + 1], 9) - round_key[2*j];
			a = round_key[2*j] - b;

			b = inv_MDS_mult(ror(b, 8));
			a = inv_MDS_mult(a);

			tmp[8*j + 0] = IBOX[1][(a >> 0 ) & 0x000000ff];
			tmp[8*j + 1] = IBOX[0][(a >> 8 ) & 0x000000ff];
			tmp[8*j + 2] = IBOX[1][(a >> 16) & 0x000000ff];
			tmp[8*j + 3] = IBOX[0][(a >> 24) & 0x000000ff];
			tmp[8*j + 4] = IBOX[1][(b >> 0 ) & 0x000000ff];
			tmp[8*j + 5] = IBOX[0][(b >> 8 ) & 0x000000ff];
			tmp[8*j + 6] = IBOX[1][(b >> 16) & 0x000000ff];
			tmp[8*j + 7] = IBOX[0][(b >> 24) & 0x000000ff];
		}

		if (!attack128(tmp, key, 0)){
			if (!attack128(tmp, key, 1)){
				sprintBuffer_raw(key_str, (char*)key, TWOFISH_128_NB_BYTE_KEY);
				multiColumnPrinter_print(printer, chunk->file_name, "Twofish 128", "l", "-", chunk->offset + i, key_str);
				continue;
			}
		}

		if (!attack192(tmp, key, 0)){
			if (!attack192(tmp, key, 1)){
				sprintBuffer_raw(key_str, (char*)key, TWOFISH_192_NB_BYTE_KEY);
				multiColumnPrinter_print(printer, chunk->file_name, "Twofish 192", "l", "-", chunk->offset + i, key_str);
				continue;
			}
		}

		if (!attack256(tmp, key, 0)){
			if (!attack256(tmp, key, 1)){
				sprintBuffer_raw(key_str, (char*)key, TWOFISH_256_NB_BYTE_KEY);
				multiColumnPrinter_print(printer, chunk->file_name, "Twofish 256", "l", "-", chunk->offset + i, key_str);
				continue;
			}
		}
	}
}
